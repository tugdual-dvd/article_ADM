---
title: "Analyse critique de l'article Assembly of microbial communities in replicate nutrient-cycling model ecosystems follows divergent trajectories, leading to alternate stable states, de Pagaling et al. (2017)"
output: github_document
date: "2025-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

## 1. INTRODUCTION 


L’assemblage des communautés microbiennes est influencé par des processus déterministes et stochastiques. Comprendre comment ces mécanismes conduisent à des trajectoires de développement divergentes reste une question centrale en écologie microbienne. L'article "Assembly of microbial communities in replicate nutrient-cycling model ecosystems follows divergent trajectories, leading to alternate stable states", de Pagaling et al. (2017) montre que des microcosmes identiques peuvent évoluer vers des états communautaires distincts.

Objectifs de cette analyse :
  1) Tester si les communautés diffèrent entre 8 et 16 semaines
  2) Identifier les groupes taxonomiques associés à cette divergence

## 2. MATERIEL ET METHODES


# Traitement des séquences

Les séquences 16S rRNA ont été traitées à l’aide du pipeline DADA2, incluant le filtrage de qualité, la correction des erreurs, la fusion des lectures appariées et l’élimination des séquences chimériques.
Ce traitement a conduit à une table finale de variants de séquences (ASV).

Les tables d’abondance, la taxonomie et les métadonnées ont ensuite été intégrées dans un objet phyloseq, utilisé pour l’ensemble des analyses.

# Analyses statistiques

Les différences de structure communautaire ont été évaluées à l’aide de la distance de Bray–Curtis calculée à partir des abondances relatives.
Les patrons de similarité entre communautés ont été explorés par PCoA.
La significativité des différences entre groupes a été testée par PERMANOVA
(adonis2).

## 3. PACKAGES

```{r, cache=TRUE}
library(dada2)
library(phyloseq)
library(vegan)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
vignette("phyloseq-basics")
vignette("phyloseq-analysis")
```

## 4. EXTRACTION DES DONNEES

```{r, cache=TRUE}

raw <- readLines("/home/rstudio/article_ADM/SraRunTable (2).csv")
raw <- gsub('^"|"$', "", raw)
raw <- gsub('""', '"', raw)
writeLines(raw, "/home/rstudio/article_ADM/SraRunTable_clean.csv")
samdf <- read.csv("/home/rstudio/article_ADM/SraRunTable_clean.csv", sep = ",", header = TRUE, quote = "\"", stringsAsFactors = FALSE)

```

## 5. PIPELINE DADA2

```{r, cache=TRUE}
path <- "~/article_ADM/data" # CHANGE ME to the directory containing the fastq files after unzipping.
list.files(path)
```
```{r, cache=TRUE}
fnFs <- sort(list.files(path, pattern = "_1\\.fastq\\.gz$", full.names = TRUE))
fnRs <- sort(list.files(path, pattern = "_2\\.fastq\\.gz$", full.names = TRUE))

sample.names <- sub("_1\\.fastq\\.gz$", "", basename(fnFs))

```

```{r, cache=TRUE}
plotQualityProfile(fnFs[1:2])
```
```{r, cache=TRUE}
plotQualityProfile(fnRs[1:2])
```

```{r, cache=TRUE}
# Create filtered directory if it doesn't exist
filt_path <- file.path(path, "filtered")
dir.create(filt_path, showWarnings = FALSE)

# Define filtered file names
filtFs <- file.path(filt_path, paste0(sample.names, "_1_filt.fastq.gz"))
filtRs <- file.path(filt_path, paste0(sample.names, "_2_filt.fastq.gz"))

# Name the vectors (important for DADA2)
names(filtFs) <- sample.names
names(filtRs) <- sample.names

```
```{r, cache=TRUE}
head(fnFs)
head(filtFs)

```

```{r, cache=TRUE}
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(240,160),
              maxN=0, maxEE=c(2,2), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=FALSE) # On Windows set multithread=FALSE (only needed for filterAndTrim)
head(out)
```
```{r,cache=TRUE}
errF <- learnErrors(filtFs, multithread=TRUE)
```
```{r,cache=TRUE}
errR <- learnErrors(filtRs, multithread=TRUE)
```
```{r, cache=TRUE}
plotErrors(errF, nominalQ=TRUE)
```
```{r, cache=TRUE}
dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
```
```{r, cache=TRUE}
dadaRs <- dada(filtRs, err=errR, multithread=TRUE)
```
```{r, cache=TRUE}
dadaFs[[1]]
```

```{r, cache=TRUE}
mergers <- mergePairs(dadaFs, filtFs, dadaRs, filtRs, verbose=TRUE)
head(mergers[[1]])
```
```{r, cache=TRUE}
seqtab <- makeSequenceTable(mergers)
dim(seqtab)
```
```{r, cache=TRUE}
table(nchar(getSequences(seqtab)))
```
```{r, cache=TRUE}
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)
```

```{r, cache=TRUE}
sum(seqtab.nochim)/sum(seqtab)
```
```{r, cache=TRUE}
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))
colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names
head(track)
```
```{r, cache=TRUE}
taxa <- assignTaxonomy(seqtab.nochim, "~/article_ADM/data/silva_nr99_v138.2_toGenus_trainset.fa.gz?download=1", multithread=TRUE)
```

```{r, cache=TRUE}
taxa.print <- taxa 
rownames(taxa.print) <- NULL
head(taxa.print)
```



```{r, cache=TRUE}
theme_set(theme_bw())
```
```{r cache=TRUE}
rownames(samdf) <- samdf$Run


length(rownames(seqtab.nochim))
length(rownames(samdf))
common.samples <- intersect(rownames(seqtab.nochim), rownames(samdf))
length(common.samples)
seqtab.nochim <- seqtab.nochim[common.samples, , drop = FALSE]
samdf <- samdf[common.samples, , drop = FALSE]

```

```{r, cache=TRUE}
# Check sample name matching
all(rownames(seqtab.nochim) %in% rownames(samdf))
all(rownames(samdf) %in% rownames(seqtab.nochim))
```
## 6. CREATION DE L'OBJET PHYLOSEQ

```{r, cache=TRUE}
ps <- phyloseq(
  otu_table(seqtab.nochim, taxa_are_rows = FALSE),
  sample_data(samdf),
  tax_table(taxa)
)

```

## 7. Création des groupes d'échantillons

```{r, cache=TRUE}
samdf$SampleGroup <- ifelse(grepl("^16", samdf$Sample.Name), "Week 16",
                       ifelse(grepl("^8",  samdf$Sample.Name), "Week 8",
                       ifelse(grepl("^SA", samdf$Sample.Name), "Sediment",
                              "Other")))
sample_data(ps) <- samdf
```

## 8. TEST D'ALPHA DIVERSITE

```{r, cache=TRUE}
plot_richness(ps, measures=c("Shannon", "Simpson"), color="SampleGroup")

```

## 9. TEST DE BETA DIVERSITE (BRAY-CURTIS)

```{r, cache=TRUE}
ps.prop <- transform_sample_counts(ps, function(otu) otu/sum(otu))
ord.nmds.bray <- ordinate(ps.prop, method="NMDS", distance="bray")
```


```{r, cache=TRUE}
plot_ordination(ps.prop, ord.nmds.bray, color="SampleGroup", title="Bray NMDS")
```

## 10. PCoA

```{r, cache=TRUE}
ps.rel <- transform_sample_counts(ps, function(x) x / sum(x))

ord.pcoa <- ordinate(ps.rel, method = "PCoA", distance = "bray")


plot_ordination(ps.rel, ord.pcoa, color = "SampleGroup") +
  geom_point(size = 2) +
  stat_ellipse() +
  ggtitle("PCoA - Bray-Curtis")


```
-->  Analyse PCoA basée sur les distances de Bray–Curtis entre communautés microbiennes sédimentaires, ainsi qu'à 8 et 16 semaines.

L’analyse en coordonnées principales montre une séparation claire entre les communautés microbiennes sédimentaires, celles échantillonnées à 8 semaines et celles échantillonnées à 16 semaines. Les échantillons de même durée d’incubation tendent à se regrouper, indiquant une structuration temporelle marquée des communautés.

## 11. PERMANOVA

```{r}
ps.rel <- transform_sample_counts(ps, function(x) x / sum(x))
dist.bray <- phyloseq::distance(ps.rel, method = "bray")

meta <- as(sample_data(ps.rel), "data.frame")

adonis2(dist.bray ~ SampleGroup, data = meta, permutations = 999)
```
```{r, cache=TRUE}

bd <- betadisper(dist.bray, meta$SampleGroup)
anova(bd)

```
PERMANOVA revealed a significant effect of SampleGroup on microbial community composition (Bray–Curtis, R² = 0.42, p = 0.001). However, multivariate dispersion differed significantly among groups (betadisper, p = 0.018), indicating that group differences may partly reflect heterogeneity in within-group variability.

## 12. COMPOSITION TAXONOMIQUE

```{r, cache=TRUE}

top10 <- names(sort(taxa_sums(ps), decreasing = TRUE))[1:10]


ps.prop <- transform_sample_counts(ps, function(x) x / sum(x))


ps.top10 <- prune_taxa(top10, ps.prop)


plot_bar(ps.top10, x = "Run", fill = "Phylum") +
  facet_wrap(~SampleGroup, scales = "free_x") +
  theme_bw() +
  ylab("Abondance relative") +
  ggtitle("Phylum bactériens dominants")
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    strip.background = element_rect(fill = "grey90")
  )


```

## 13. HEATMAP

```{r, cache=TRUE, fig.width=10, fig.height=8}

ps.rel <- transform_sample_counts(ps, function(x) x / sum(x))


ps.phylum <- tax_glom(ps.rel, taxrank = "Phylum")


top20 <- names(sort(taxa_sums(ps.phylum), decreasing = TRUE))[1:20]
ps.phylum.top <- prune_taxa(top20, ps.phylum)


mat <- as(otu_table(ps.phylum.top), "matrix")
if (!taxa_are_rows(ps.phylum.top)) mat <- t(mat)


mat <- matrix(as.numeric(mat),
              nrow = nrow(mat),
              dimnames = dimnames(mat))
mat[!is.finite(mat)] <- 0


mat.log <- log10(mat + 1e-6)


mat.z <- t(scale(t(mat.log)))
mat.z[!is.finite(mat.z)] <- 0


tax <- as(tax_table(ps.phylum.top), "matrix")
rownames(mat.z) <- tax[, "Phylum"]


ann_col <- data.frame(
  SampleGroup = sample_data(ps.phylum.top)$SampleGroup
)
rownames(ann_col) <- sample_names(ps.phylum.top)


ord <- order(ann_col$SampleGroup)
mat.z <- mat.z[, ord]
ann_col <- ann_col[ord, , drop = FALSE]


col_fun <- colorRampPalette(rev(brewer.pal(11, "RdBu")))(100)


pheatmap(mat.z,
         annotation_col = ann_col,
         color = col_fun,
         scale = "none",
         clustering_method = "average",
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         show_colnames = FALSE,
         fontsize_row = 10,
         fontsize_col = 8,
         border_color = NA,
         main = "Heatmap of the 20 most abundant bacterial phyla\n(Z-score of log-relative abundance)")

```

## DISCUSSION

Les résultats obtenus montrent que des communautés microbiennes initialement similaires peuvent diverger fortement au cours du temps, même lorsqu’elles évoluent dans des conditions environnementales contrôlées. La séparation nette observée entre 8 et 16 semaines suggère que la dynamique temporelle joue un rôle clé dans l’assemblage des communautés.

Ces observations sont cohérentes avec les conclusions de Pagaling et al. (2017), qui proposent que des trajectoires alternatives d’assemblage puissent émerger à la suite d’une phase initiale de faible diversité. La divergence observée pourrait résulter d’effets stochastiques amplifiés par des interactions biologiques et des rétroactions fonctionnelles au sein des communautés.

Cependant, notre analyse reste volontairement limitée par rapport à l’étude originale, qui inclut des approches fonctionnelles et métagénomiques plus approfondies. Néanmoins, cette reproduction partielle met en évidence l’intérêt des analyses de diversité beta et de composition taxonomique pour explorer les mécanismes d’assemblage des communautés microbiennes.

## CONCLUSION

Cette analyse montre que la structure des communautés microbiennes évolue significativement entre 8 et 16 semaines d’incubation, avec une divergence marquée de leur composition. Les résultats soutiennent l’hypothèse selon laquelle des communautés microbiennes répliquées peuvent suivre des trajectoires de développement distinctes, contribuant à la compréhension des états alternatifs en écologie microbienne.